<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/adminLayout}">

<th:block layout:fragment="script">
  <script th:inline="javascript">
    let message = [[${message}]];
    if(message != null) alert(message);

    'use strict';

     function productDelete(id, model) {
      let ans = confirm(model+'을 삭제하시겠습니까?');
      if(ans) {
        $.ajax({
          url   : '/admin/product/productDelete/'+id,
          data  : {id:id},
          type  : 'post',
          success : (res) => {
            if(res == 'OK') {
              alert("센서를 삭제했습니다.");
              location.reload();
            }
            else {
              alert("센서를 삭제하지 못했습니다");
              location.reload();
            }
          },
          error : () => alert("전송오류")
        });
      }
    }

    function openProductModal(id) {
      $.ajax({
        url: '/admin/product/detail/'+id,
        type: 'get',
        data: {id : id},
        success: function(productDTO) {
          $('#updateBtn').attr('data-id', productDTO.id)
          $('#pImg').attr('src', '/admin/product/'+productDTO.sensorImage);
          $('#pModel').text(productDTO.model);
          $('#pName').text(productDTO.sensorName);
          $('#pSDescription').text(productDTO.shortDescription);
          $('#pFeatures').text(productDTO.features);
          $('#pSensorType').text(productDTO.sensorType);
          $('#pManufacturer').text(productDTO.manufacturer);
          let modal = new bootstrap.Modal(document.getElementById('productModal'));
          modal.show();
        },
        error: function() {
          alert('센서 정보를 불러오지 못했습니다.');
        }
      });
    }

    function productUpdate() {
      let id = $('#updateBtn').data('id');
      if(id) {
        location.href = '/admin/product/productUpdate/'+id;
      }
    }
  </script>
</th:block>
<th:block layout:fragment="css">
  <style>
    #productModal .modal-content {
      animation: fadeSlide .35s ease;
    }
    @keyframes fadeSlide {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</th:block>
<div layout:fragment="content">
  <h2 class="text-center mb-2">센서 리스트</h2>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle text-center">
          <thead class="table-dark">
          <tr>
            <th>번호</th>
            <th>모델</th>
            <th>센서이름</th>
            <th>센서타입</th>
            <th>제조사</th>
            <th>관리</th>
          </tr>
          </thead>
          <tbody>
          <th:block th:each="product, st : ${pageDTO.productList}">
            <tr>
              <td>[[${pageDTO.curScrStartNo - st.index}]]</td>
              <td>[[${product.model}]]</td>
              <td>[[${product.sensorName}]]</td>
              <td>[[${product.sensorType}]]</td>
              <td>[[${product.manufacturer}]]</td>
              <td class="text-center">
                <div class="d-flex justify-content-center gap-2">
                  <button type="button" class="btn btn-sm btn-outline-primary"
                          th:onclick="|openProductModal(${product.id})|">보기
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-dark"
                          th:onclick="|location.href='/admin/product/productUpdate/'+${product.id}|">수정
                  </button>
                  <button type="button"
                          th:data-id="${product.id}"
                          th:data-model="${product.model}"
                          th:onclick="|productDelete(this.getAttribute('data-id'), this.getAttribute('data-model'))|"
                          class="btn btn-sm btn-outline-danger">삭제
                  </button>
                </div>
              </td>
            </tr>
          </th:block>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content shadow-lg rounded-3">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">
            <i class="bi bi-info-circle-fill me-2"></i>센서정보
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 d-flex align-items-stretch">
            <div class="col-md-5">
              <div class="card shadow-sm border-0 h-100"><!--max-width:100%;-->
                <img id="pImg" src="" alt="센서이미지" style="max-width:100%; height:100%; object-fit:cover;">
              </div>
            </div>
            <div class="col-md-7">
              <div class="card border-0">
                <div class="card-body">
                  <h5 class="fw-bold mb-3">
                    <span id="pName"></span>
                    <span class="badge bg-secondary" id="pSensorType"></span>
                  </h5>
                  <p>
                    <strong class="text-muted"><i class="bi bi-cpu-fill"></i> 모델</strong><br>
                    <span id="pModel"></span>
                  </p>
                  <p>
                    <strong class="text-muted"><i class="bi bi-card-text"></i> 설명</strong><br>
                    <span id="pSDescription"></span>
                  </p>
                  <p>
                    <strong class="text-muted"><i class="bi bi-stars"></i> 특징</strong><br>
                    <span id="pFeatures"></span>
                  </p>
                  <p>
                    <strong class="text-muted"><i class="bi bi-gear-fill"></i> 제조사</strong><br>
                    <span id="pManufacturer"></span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button class="btn btn-primary" id="updateBtn" data-id="" onclick="productUpdate()">수정하기</button>
        </div>
      </div>
    </div>
  </div>
  <div class="text-center">
    <ul class="pagination justify-content-center">
      <th:block th:if="${pageDTO.pag > 1}"><li class="page-item"><a class="page-link text-secondary" th:href="@{productList(pageSize=${pageDTO.pageSize},pag=0)}">첫페이지</a></li></th:block>
      <th:block th:if="${pageDTO.curBlock > 0}"><li class="page-item"><a class="page-link text-secondary" th:href="@{productList(pageSize=${pageDTO.pageSize},pag=${(pageDTO.curBlock-1)*pageDTO.blockSize+1-1})}">이전블록</a></li></th:block>
      <th:block th:each="i: ${#numbers.sequence((pageDTO.curBlock*pageDTO.blockSize)+1,(pageDTO.curBlock*pageDTO.blockSize)+pageDTO.blockSize)}">
        <th:block th:if="${i <= pageDTO.totPage && i == pageDTO.pag}"><li class="page-item active"><a class="page-link bg-secondary border-secondary" th:href="@{productList(pageSize=${pageDTO.pageSize},pag=${i-1})}" th:text="${i}"></a></li></th:block>
        <th:block th:if="${i <= pageDTO.totPage && i != pageDTO.pag}"><li class="page-item"><a class="page-link text-secondary" th:href="@{productList(pageSize=${pageDTO.pageSize},pag=${i-1})}" th:text="${i}"></a></li></th:block>
      </th:block>
      <th:block th:if="${pageDTO.curBlock < pageDTO.lastBlock}"><li class="page-item"><a class="page-link text-secondary" th:href="@{productList(pageSize=${pageDTO.pageSize},pag=${(pageDTO.curBlock+1)*pageDTO.blockSize+1-1})}">다음블록</a></li></th:block>
      <th:block th:if="${pageDTO.pag < pageDTO.totPage}"><li class="page-item"><a class="page-link text-secondary" th:href="@{productList(pageSize=${pageDTO.pageSize},pag=${pageDTO.totPage-1})}">마지막페이지</a></li></th:block>
    </ul>
  </div>
</div>
</html>