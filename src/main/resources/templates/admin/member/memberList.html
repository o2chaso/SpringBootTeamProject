<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layouts/basicLayout}">

<th:block layout:fragment="script">
  <script th:inline="javascript">
    let message = [[${message}]];
    if(message != null) alert(message);

    'use strict';
    function memberDelete(id, email) {
      let ans = confirm(email+'님을 삭제하시겠습니까?');
      if(ans) {
        $.ajax({
          url   : '/admin/member/memberDelete/'+id,
          data  : {id:id},
          type  : 'post',
          success : (res) => {
            if(res == 'OK') {
              alert("회원을 삭제했습니다.");
              location.reload();
            }
            else {
              alert("회원을 삭제하지 못했습니다");
              location.reload();
            }
          },
          error : () => alert("전송오류")
        });
      }
    }

    function openMemberModal(id) {
      $.ajax({
        url: '/admin/member/detail/'+id,
        type: 'get',
        success: function(member) {
          $('#mImg').attr('src', member.profileImage == 'noImage.jpg'
          ? '/images/noImage.jpg'
          : '/member/profile/'+member.profileImage);
          $('#mName').text(member.name);
          $('#mEmail').text(member.email);
          $('#mTel').text(member.tel);
          $('#mAddr').text(member.address.replace(/\//g, ''));
          $('#mRole').text(member.role);
          let modal = new bootstrap.Modal(document.getElementById('memberModal'));
          modal.show();
        },
        error: function() {
          alert('회원 정보를 불러오지 못했습니다.');
        }
      });
    }
  </script>
</th:block>
<div layout:fragment="content">
  <h2 class="text-center mb-2">회원 리스트</h2>
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>번호</th>
              <th>이름</th>
              <th>이메일</th>
              <th>전화번호</th>
              <th>주소</th>
              <th>권한</th>
              <th>상태</th>
              <th>관리</th>
            </tr>
          </thead>
          <tbody>
            <th:block th:each="member, st : ${pageDTO.memberList}">
              <tr>
                <td>[[${pageDTO.curScrStartNo - st.index}]]</td>
                <td>[[${member.name}]]</td>
                <td>[[${member.email}]]</td>
                <td>[[${member.tel}]]</td>
                <td th:text="${#strings.replace(member.address, '/', '')}"></td>
                <td>[[${member.role}]]</td>
                <td>
                  <span th:if="${member.userDel.name() == 'NO'}"
                          class="badge bg-success">활성</span>
                    <span th:if="${member.userDel.name() == 'OK'}"
                          class="badge bg-danger">탈퇴</span>
                  <!--[[${member.userDel}]]-->
                </td>
                <td class="text-center d-flex">
                  <button type="button" class="btn btn-sm btn-outline-primary"
                      th:onclick="|openMemberModal(${member.id})|">보기
                  </button>
                  <button type="button"
                          th:data-id="${member.id}"
                          th:data-email="${member.email}"
                          th:onclick="|memberDelete(this.getAttribute('data-id'), this.getAttribute('data-email'))|"
                          th:classappend="${member.userDel.name() != 'OK'} ? 'd-none' : ''"
                          class="btn btn-sm btn-outline-danger">삭제
                  </button>
                </td>
              </tr>
            </th:block>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="modal fade" id="memberModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content shadow-lg rounded-3">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">
            <i class="bi bi-person-circle me-2"></i>회원 정보
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 d-flex align-items-stretch">
            <div class="col-md-5">
              <div class="card shadow-sm border-0 h-100">
                <img id="mImg" src="" alt="회원 이미지" style="max-width:100%; height:100%; object-fit:cover;">
              </div>
            </div>
            <div class="col-md-7">
              <div class="card border-0">
                <div class="card-body">
                  <h5 class="fw-bold mb-3">
                    <span id="mName"></span>
                    <span class="badge bg-secondary" id="mRole"></span>
                  </h5>
                  <p>
                    <strong class="text-muted"><i class="bi bi-envelope-fill"></i> 이메일</strong><br>
                    <span id="mEmail"></span>
                  </p>
                  <p>
                    <strong class="text-muted"><i class="bi bi-telephone-fill"></i> 전화번호</strong><br>
                    <span id="mTel"></span>
                  </p>
                  <p>
                    <strong class="text-muted"><i class="bi bi-house-door-fill"></i> 주소</strong><br>
                    <span id="mAddr"></span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>
  <div class="text-center">
    <ul class="pagination justify-content-center">
      <th:block th:if="${pageDTO.pag > 1}"><li class="page-item"><a class="page-link text-secondary" th:href="@{memberList(pageSize=${pageDTO.pageSize},pag=0)}">첫페이지</a></li></th:block>
      <th:block th:if="${pageDTO.curBlock > 0}"><li class="page-item"><a class="page-link text-secondary" th:href="@{memberList(pageSize=${pageDTO.pageSize},pag=${(pageDTO.curBlock-1)*pageDTO.blockSize+1-1})}">이전블록</a></li></th:block>
      <th:block th:each="i: ${#numbers.sequence((pageDTO.curBlock*pageDTO.blockSize)+1,(pageDTO.curBlock*pageDTO.blockSize)+pageDTO.blockSize)}">
        <th:block th:if="${i <= pageDTO.totPage && i == pageDTO.pag}"><li class="page-item active"><a class="page-link bg-secondary border-secondary" th:href="@{memberList(pageSize=${pageDTO.pageSize},pag=${i-1})}" th:text="${i}"></a></li></th:block>
        <th:block th:if="${i <= pageDTO.totPage && i != pageDTO.pag}"><li class="page-item"><a class="page-link text-secondary" th:href="@{memberList(pageSize=${pageDTO.pageSize},pag=${i-1})}" th:text="${i}"></a></li></th:block>
      </th:block>
      <th:block th:if="${pageDTO.curBlock < pageDTO.lastBlock}"><li class="page-item"><a class="page-link text-secondary" th:href="@{memberList(pageSize=${pageDTO.pageSize},pag=${(pageDTO.curBlock+1)*pageDTO.blockSize+1-1})}">다음블록</a></li></th:block>
      <th:block th:if="${pageDTO.pag < pageDTO.totPage}"><li class="page-item"><a class="page-link text-secondary" th:href="@{memberList(pageSize=${pageDTO.pageSize},pag=${pageDTO.totPage-1})}">마지막페이지</a></li></th:block>
    </ul>
  </div>
</div>
</html>