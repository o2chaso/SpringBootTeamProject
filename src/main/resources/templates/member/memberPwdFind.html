<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/basicLayout}">

<th:block layout:fragment="script">
  <script th:inline="javascript">
    let message = [[${message}]];
    if(message != null) alert(message);

    let regEmail =/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/;
    let timeLimit = 180;
    let interval;
    let emailSw = 0;


    function fCheck() {
      emailSw = $("#emailSw").val();

      if(emailSw != 1) {
        alert("이메일 인증을 해주세요");
        return false;
      }
      form.submit();
    }

    function emailCertification() {
      let email = form.email.value.trim();

      if(email == '') {
        alert("이메일을 입력해주세요");
        form.email.focus();
        return false;
      }
      else if(!regEmail.test(email)) {
        alert("이메일 형식에 맞지 않습니다.");
        form.email.focus();
        return false;
      }

      let spin = "<div class='text-center'><div class='spinner-border text-muted'></div> 메일 발송중입니다. 잠시만 기다려주세요 <div class='spinner-border text-muted'></div></div>";
        $("#demoSpin").show().html(spin);
        $("#email").prop("readonly", true);
        $.ajax({
          url 	: '/SpringGroupBB/member/memberEmailCheck',
          type 	: 'post',
          data 	:{
            email : email,
            flag : 2
          },
          success : (res) => {
            if(res=='OK') {
              alert("인증번호가 발송되었습니다");
              let str = '<label for="checkKey" class="col-auto col-form-label">인증번호</label>';
              str += '<div class="col-md-4">';
              str += '<div class="input-group">';
              str += '<input type="text" name="checkKey" id="checkKey" class="form-control"/>';
              str += '<span id="timeLimit" class="input-group-text">남은시간 : 180초</span>';
              str += '<input type="button" value="확인" onclick="emailCertificationOk()" class="btn btn-primary btn-sm"/>';
              str += '</div></div>';
              $("#demoSpin").html(str);
              $("#emailBtn").hide();
              $("#emailResetBtn").show();

              timer();
            }
            else {
              alert("인증번호 확인버튼을 다시 눌러주세요!");
              $("#email").prop("readonly", false);
            }
          },
          error : () => alert("전송오류")
        });
      }
    function timer() {
      clearInterval(interval);
      timeLimit = 180;

      interval = setInterval(() => {
        $("#timeLimit").html("남은시간 : "+timeLimit+"초");

        if(timeLimit == 0){
          $("#demoSpin").html("");
          timeLimit = 180;

          $.ajax({
            url 		: '/SpringGroupBB/member/memberEmailCheckNo',
            type 		: 'post',
            success : () => {
              $("#emailSw").val(0);
              alert("인증시간이 만료되었습니다.")
            },
            error 	: () => alert("전송오류")
          });
          clearInterval(interval);
        }
        timeLimit--;
      }, 1000);
    }

    function emailCertificationOk() {
      let checkKey = $("#checkKey").val();

      if(checkKey.trim()=="") {
        alert("메일로 전송받은 인증키를 입력해주세요");
        form.checkKey.focus();
        return false;
      }
      $.ajax({
        url 	: '/SpringGroupBB/member/memberEmailCheckOk',
        type 	: 'post',
        data 	: {checkKey:checkKey},
        success : (res) => {
          if(res == 'OK') {
            clearInterval(interval);
            $("#demoSpin").hide();
            alert("인증번호를 확인되었습니다");
            $("#emailSw").val(1);
          }
          else {
            alert("인증번호 오류 인증번호를 확인해주세요.");
            form.checkKey.focus();
          }
        },
        error : () => alert("전송오류")
      });
    }

    function emailReset() {
      clearInterval(interval);

      $("#demoSpin").empty().hide();
      $("#emailResetBtn").hide();
      $("#emailBtn").prop("disabled", false);
      $("#emailBtn").show();
      $("#email").prop("readonly", false);
      $("#emailSw").val(0);
    }
  </script>
</th:block>

<style layout:fragment="css" >
  body {
    font-family: Arial, sans-serif;
  }
  .row {
    margin: 0px;
    padding: 10px;
    align-items: center;
  }
  .row label {
    width: 120px;
    text-align: right;
    margin-right: 10px;
  }
</style>

<div layout:fragment="content">
  <div class="device-card">
    <h2>비밀번호 찾기</h2>
  </div>
  <div class="device-card">
    <form name="form" method="post" class="flex-grow-1">
      <div class="row align-items-center justify-content-center">
        <label for="name" class="col-auto col-form-label">이름</label>
        <div class="col-md-4">
          <div class="input-group">
            <input type="text" name="name" id="name" class="form-control" placeholder="이름을 입력해주세요" />
          </div>
        </div>
      </div>
      <div class="row align-items-center justify-content-center">
        <label for="email" class="col-auto col-form-label">이메일</label>
        <div class="col-md-4">
          <div class="input-group">
            <input type="email" id="email" name="email" class="form-control" placeholder="이메일을 입력해주세요">
            <button type="button" id="emailBtn" onclick="emailCertification()"
                    class="btn btn-dark btn-sm text-white">이메일 인증
            </button>
            <button type="button" id="emailResetBtn" onclick="emailReset()"
                    class="btn btn-dark btn-sm text-white" style="display:none">다시 입력</button>
          </div>
        </div>
      </div>
      <div id="demoSpin" class="row mb-1 align-items-center justify-content-center" style="display:none"></div>
      <div class="d-flex justify-content-center gap-3 mt-4">
        <button type="button" class="btn btn-dark w-40 px-4" onclick="fCheck()">비밀번호 찾기</button>
        <button type="button" class="btn btn-dark w-40 px-4" onclick="location.href='/SpringGroupBB/'">취소</button>
      </div>
      <input type="hidden" id="emailSw" name="emailSw" th:value="${emailSw}" />
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    </form>
  </div>
</div>
</html>