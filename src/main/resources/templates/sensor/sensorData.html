<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/basicLayout}" xmlns="http://www.w3.org/1999/html">

<th:block layout:fragment="script">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script th:inline="javascript">
    // Global 변수
    let dataChart = null;
    let resData = null;

    // Graph Zoom Reset
    function resetZoom() {
      if(dataChart) {
        dataChart.resetZoom();
      }
    }

    window.addEventListener("load", function() {
      window.CSRF_TOKEN = /*[[${_csrf.token}]]*/ "";
      window.CSRF_HEADER = /*[[${_csrf.headerName}]]*/ "";

      document.getElementById("btnSearch").addEventListener("click", function() {
        var startDate = document.getElementById("startDate").value;
        var endDate = document.getElementById("endDate").value;
        var deviceCode = document.getElementById("deviceCode").value;
        var sensorKey = document.getElementById("sensorKey").value;

        if(startDate === "" || endDate === "") {
          alert("시작 및 종료 날짜를 선택하세요");
          return;
        }

        startDate = startDate.replace("T", " ");
        endDate = endDate.replace("T", " ");

        $.ajax({
          url : "/SpringGroupBB/sensor/sensorSearch",
          type: "get",
          headers: (function() {
            var h = {};
            h[window.CSRF_HEADER] = window.CSRF_TOKEN;
            return h;
          })(),
          data: {
            startDate: startDate,
            endDate: endDate,
            deviceCode: deviceCode,
            sensorKey: sensorKey
          },
          success: function(res) {
            resData = res;
            let labels = [];
            let values = [];
            let alarms = [];
            let warnings = [];
            for(let i = 0; i < res.length; i++) {
              const e = res[i];
              labels.push(e.measureDatetime.substring(0, 10) + " " + e.measureDatetime.substring(11, 16));
              values.push(e[sensorKey]);
              if(e.threshold != null) {
                alarms.push(e.threshold.alarm);
                warnings.push(e.threshold.warning);
              }
              else {
                alarms.push(null);
                warnings.push(null);
              }
              document.getElementById("chartTable").innerText = deviceCode + ": " + getSensorName(sensorKey);
            }

            // SensorName Mapping
            function getSensorName(key) {
              switch(key) {
                case "value1": return "실내온도";
                case "value2": return "상대습도";
                case "value3": return "이산화탄소";
                case "value4": return "유기화합물VOC";
                case "value5": return "초미세먼지 PM1.0";
                case "value6": return "초미세먼지 PM2.5";
                case "value7": return "초미세먼지 PM10";
                case "value8": return "온도_1";
                case "value9": return "온도_2";
                case "value10": return "온도_3";
                case "value11": return "소음";
                case "value12": return "비접촉 온도";
                case "value13": return "조도";
                default: return key;
              }
            }
            // Graph ========================================================================
            // x축 날짜를 '문자'로 세틸해서 pan 사용 불가...
            var ctx = document.getElementById('dataChart').getContext('2d');

            // 이미 있는 차트면 삭제
            if(dataChart != null) dataChart.destroy();

            // 객체 생성
            let data = {
              labels: labels,
              datasets: [
                {
                  label: "" + getSensorName(sensorKey),  // 센서 값 라벨
                  data: values,           // 센서 값
                  borderColor: "green",   // Line Color
                  tension: 0.1,           // Line 부드럽게 표현
                  pointRadius: 0          // point 지우기
                },
                {
                  label: "Sensor Alarm",  // 센서 값 라벨
                  data: alarms,           // 워닝 값
                  borderColor: "red",     // Line Color
                  tension: 0.1,           // Line 부드럽게 표현
                  pointRadius: 0          // point 지우기
                },
                {
                  label: "Sensor Warning", // 센서 값 라벨
                  data: warnings,          // 알람 값
                  borderColor: "orange",   // Line Color
                  tension: 0.1,            // Line 부드럽게 표현
                  pointRadius: 0           // point 지우기
                }
              ]
            };

            // Alarm 및 Warning 음영 플러그인
            const bgColorPlugin = {
              id: "bgColorPlugin",
              beforeDraw: function(chart, args, options) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                const yScale = chart.scales.y;

                // 기준값
                const alarmValue = options.alarm;
                const warningValue = options.warning;
                if(alarmValue == null && warningValue == null) return;
                ctx.save();

                // 1) 알람 영역 (alarmValue 이상)
                if(alarmValue != null) {
                  const alarmY = yScale.getPixelForValue(alarmValue);
                  ctx.fillStyle = "rgba(255, 0, 0, 0.15)";
                  ctx.fillRect(
                    chartArea.left,
                    chartArea.top,
                    chartArea.right - chartArea.left,
                    alarmY - chartArea.top
                  );
                }

                // 2) 워닝 영역 (warningValue 이상 ~ alarmValue 미만)
                if(warningValue != null) {
                  const warningY = yScale.getPixelForValue(warningValue);
                  let bottomY = chartArea.bottom;
                  if(alarmValue != null) {
                    bottomY = yScale.getPixelForValue(alarmValue);
                  }
                  ctx.fillStyle = "rgba(255, 165, 0, 0.15)";
                  ctx.fillRect(
                    chartArea.left,
                    warningY,
                    chartArea.right - chartArea.left,
                    bottomY - warningY
                  );
                }
                ctx.restore();
              }
            };

            // Graph 출력
            dataChart = new Chart(ctx, {
              type: 'line',
              data: data,
              options: {
                responsive: true,
                plugins: {
                  bgColorPlugin: {
                    alarm: alarms[0],
                    warning: warnings[0]
                  },
                  zoom: {
                    zoom: {
                      wheel: {
                        enabled: true
                      },
                      pinch: {
                        enabled: true
                      },
                      mode: 'x'
                    }
                  },
                  legend: {
                    position: 'top',
                  }
                },
                scales: {
                  x: {
                    display: true,
                    title: {
                      display: true
                    }
                  },
                  y: {
                    display: true,
                    title: {
                      display: true,
                    },
                    afterDataLimits: function(scale) {
                      scale.max = scale.max + 5;
                      scale.min = scale.min -5;
                    }
                  }
                }
              },
              plugins: [bgColorPlugin]
            });
          },
          error: function(error) {
            alert("조회 실패");
          }
        });
      });
    });

    // 날짜 기본값 주기
    window.addEventListener("load", function() {
      var today = new Date().toISOString().substring(0, 10);
      document.getElementById("startDate").value = today;
      document.getElementById("endDate").value = today;
    });

    // Graph Print
    function printPage() {
      var canvas = document.getElementById("dataChart");
      var imgData = canvas.toDataURL("image/png");
      // 새 창 열기
      var win = window.open("", "PRINT", "height=800,width=1000");
      // 이미지 작성
      win.document.write("<html><head><title>그래프 출력</title>");
      win.document.write("</head><body>");
      win.document.write("<h3>그래프 출력</h3>");
      win.document.write("<img src='" + imgData + "' style='max-width:100%;'/>");
      win.document.write("</body></html>");
      win.document.close();  // DOM 닫기
      // 로드 후 출력하기
      win.onload = function() {
        win.focus();
        win.print();
        win.close();
      };
    }

    // 현재 날짜 시간 기본값 넣기
    window.addEventListener("load", function() {
      var now = new Date();

      var year = now.getFullYear();
      var month = ("0" + (now.getMonth() + 1)).slice(-2);
      var day = ("0" + now.getDate()).slice(-2);
      var hour = ("0" + now.getHours()).slice(-2);
      var minute = ("0" + now.getMinutes()).slice(-2);

      var local = year + "-" + month + "-" + day + "T" + hour + ":" + minute;

      document.getElementById("startDate").value = local;
      document.getElementById("endDate").value = local;
    });

    // 선택층 + 전체 센서 다운
    function download() {
      if(resData === null) {
        alert("자료 조회 후 시도해주세요.");
        return;
      }
      const data = resData;
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "SheetJS");
      XLSX.writeFile(wb, "sensor_detail_data.xlsx");
    }

    // 선택층 + 선택 센서 다운
    function selectDownload() {
      if(resData === null) {
        alert("자료 조회 후 시도해주세요.");
        return;
      }
      const deviceCode = document.getElementById("deviceCode").value;
      const sensorKey = document.getElementById("sensorKey").value;

      var filter = [];
      for(var i = 0; i < resData.length; i++) {
        var e = resData[i];
        if(e.deviceCode === deviceCode) {
          var obj = {};
          obj.companyId = e.companyId;
          obj.id = e.id;
          obj.deviceCode = e.deviceCode;
          obj[sensorKey] = e[sensorKey];
          obj.measureDatetime = e.measureDatetime;
          filter.push(obj);
        }
      }

      if(filter.length === 0) {
        alert("데이터가 없습니다.");
        return;
      }
      var ws = XLSX.utils.json_to_sheet(filter);
      var wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "선택센서");
      XLSX.writeFile(wb, "sensor_detail_data.xlsx");
    }
  </script>
</th:block>

<div layout:fragment="content">
  <div class="device-card data-header-card">
    <div class="container-fluid">
      <h2 class="fw-bold mb-5">센서 데이터 상세 페이지</h2>
      <div class="row">
        <!-- 왼쪽 패널 -->
        <div class="col-3 bg-white border rounded p-3 shadow-sm">
          <h5 class="fw-bold mb-3">센서 데이터 조회</h5>
          <div class="mb-3">
            <label>시작 날짜</label><br/>
            <input type="datetime-local" max="9999-12-31T23:59" step="60" id="startDate" name="startDate" class="form-control">
          </div>
          <div class="mb-3">
            <label>종료 날짜</label>
            <input type="datetime-local" max="9999-12-31T23:59" id="endDate" name="startDate" class="form-control">
          </div>
          <div class="mb-3">
          <label>장비 선택</label>
            <select id="deviceCode" class="form-select">
              <option value="ENV_V2_1">1층(ENV_V2_1)</option>
              <option value="ENV_V2_2">2층(ENV_V2_2)</option>
              <option value="ENV_V2_3">자재실(ENV_V2_3)</option>
              <option value="ENV_V2_4">개발실(ENV_V2_4)</option>
            </select>
          </div>
          <div class="mb-3">
          <label>센서 선택</label>
            <select id="sensorKey" class="form-select">
              <option value="value1">실내온도</option>
              <option value="value2">상대습도</option>
              <option value="value3">이산화탄소</option>
              <option value="value4">유기화합물VOC</option>
              <option value="value5">초미세먼지 PM1.0</option>
              <option value="value6">초미세먼지 PM2.5</option>
              <option value="value7">초미세먼지 PM10</option>
              <option value="value8">온도_1</option>
              <option value="value9">온도_2</option>
              <option value="value10">온도_3</option>
              <option value="value12">소음</option>
              <option value="value11">온도(비접촉)</option>
              <option value="value13">조도</option>
            </select>
          </div>
          <button id="btnSearch" class="btn btn-primary btn-sm">조회</button>
          <button onclick="resetZoom()" class="btn btn-primary btn-sm">Graph Reset</button>
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <div class="mt-3">
            <a th:href="@{/sensor/sensorList}" class="btn btn-secondary btn-sm mt-1 mb-3">대시보드</a>
            <input type="button" value="인쇄" onclick="printPage()" class="btn btn-secondary btn-sm mt-1 mb-3"/><br/>
            <input type="button" value="다운로드1" onclick="download()" class="btn btn-secondary btn-sm mt-1 mb-3"/>
            <input type="button" value="다운로드2" onclick="selectDownload()" class="btn btn-secondary btn-sm mt-1 mb-3"/>
          </div>
        </div>

        <!-- 오른쪽 패널 -->
        <div class="col-9">
          <div class="card shadow-sm p-3">
            <h3 id="chartTable" class="fw-bold">그래프 영역</h3>
            <canvas id="dataChart"></canvas>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
</html>