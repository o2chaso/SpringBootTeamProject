<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Sensor Popup</title>
  <link rel="icon" th:href="@{/images/favi.png}" type="image/png">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .tab-btn {
        padding: 8px 14px;
        margin-right: 10px;
        background-color: #007bff;
        border: none;
        color: white;
        cursor: pointer;
        border-radius: 5px;
    }

    .tab-btn:hover {
        background-color: #0056b3;
    }

    body {
        width: 780px;
        height: 880px;
        overflow-x: hidden;
        overflow-y: auto;
    }

    #contentArea {
        width: 740px;
        min-height: 700px;
    }

    #chart {
        width: 700px !important;
        height: 350px !important;
    }
  </style>
</head>

<body>
<div style="text-align: center;">
  <h2 style="display: inline-block;">[[${deviceCode}]]</h2>
</div>

<!-- 탭 버튼 -->
<div style="text-align: center;">
  <button class="tab-btn" onclick="loadTab('interlock')">인터락</button>
  <button class="tab-btn" onclick="loadTab('graph')">그래프</button>
  <button class="tab-btn" onclick="loadTab('eventLog')">로그</button>
</div>

<!-- 내용 표시 영역 -->
<div id="contentArea">
  <!-- AJAX로 채워질 영역 -->
</div>

<script th:inline="javascript">
  var deviceCode = [[${deviceCode}]];
  var sensorKey = [[${sensorKey}]];

  window.saveInterlock = function() {
      window.CSRF_TOKEN = /*[[${_csrf.token}]]*/ "";
      window.CSRF_HEADER = /*[[${_csrf.headerName}]]*/ "";

      const deviceCode = document.getElementById('deviceCode').value;
      const sensorKey = document.getElementById('sensorKey').value;
      const alarm = document.getElementById('alarm').value;
      const warning = document.getElementById('warning').value;
      const status = document.getElementById('status').value;

      $.ajax({
        url: "/SpringGroupBB/sensor/threshold/save",
        type: "post",
        headers: (function() {
          var h = {};
          h[window.CSRF_HEADER] = window.CSRF_TOKEN;
          return h;
        })(),
        data: {
          deviceCode: deviceCode,
          sensorKey: sensorKey,
          alarm: alarm,
          warning: warning,
          status: status
        },
        success: function(res) {
          alert("저장 완료");
        },
        error: function() {
          alert("저장 실패");
        }
      });
  };

  function loadTab(tab) {
    var url = "/SpringGroupBB/sensor/sensorPopup/detail?tab="
              + tab
              + "&deviceCode="
              + deviceCode
              + "&sensorKey="
              + sensorKey;

    $("#contentArea").load(url, function(){
      if(tab == "graph") {
        initChart();
      }
      if(tab == "eventLog") {
        initEventLog();
      }
    });
  }
  loadTab("interlock");

  // Graph ========================================================================
  function initChart() {

    // 객체 생성
    var data = {
      labels: [],                 // 시간 축(x)
      datasets: [
        {
          label: "Sensor Value",  // 센서 값 라벨
          data: [],               // 실시간 센서 값이 들어갈 배열
          borderColor: "green",   // Line Color
          tension: 0.1,           // Line 부드럽게 표현
          pointRadius: 0          // point 지우기
        },
        {
          label: "Sensor Alarm", // 센서 값 라벨
          data: [],               // 실시간 센서 값이 들어갈 배열
          borderColor: "red",     // Line Color
          tension: 0.1,           // Line 부드럽게 표현
          pointRadius: 0          // point 지우기
        },
        {
          label: "Sensor Warning", // 센서 값 라벨
          data: [],                // 실시간 센서 값이 들어갈 배열
          borderColor: "orange",   // Line Color
          tension: 0.1,            // Line 부드럽게 표현
          pointRadius: 0           // point 지우기
        }
      ]
    };
    // Alarm 및 Warning 음영 플러그인
    const bgColorPlugin = {
      id: "bgColorPlugin",
      beforeDraw: function(chart, args, options) {
        const ctx = chart.ctx;
        const chartArea = chart.chartArea;
        const yScale = chart.scales.y;

        // 기준값
        const alarmValue = options.alarm;
        const warningValue = options.warning;
        if(alarmValue == null && warningValue == null) return;
        ctx.save();

        // 1) 알람 영역 (alarmValue 이상)
        if(alarmValue != null) {
          const alarmY = yScale.getPixelForValue(alarmValue);
          ctx.fillStyle = "rgba(255, 0, 0, 0.15)";
          ctx.fillRect(
            chartArea.left,
            chartArea.top,
            chartArea.right - chartArea.left,
            alarmY - chartArea.top
          );
        }

        // 2) 워닝 영역 (warningValue 이상 ~ alarmValue 미만)
        if(warningValue != null) {
          const warningY = yScale.getPixelForValue(warningValue);
          let bottomY = chartArea.bottom;
          if(alarmValue != null) {
            bottomY = yScale.getPixelForValue(alarmValue);
          }
          ctx.fillStyle = "rgba(255, 165, 0, 0.15)";
          ctx.fillRect(
            chartArea.left,
            warningY,
            chartArea.right - chartArea.left,
            bottomY - warningY
          );
        }
        ctx.restore();
      }
    };
    // 객체 생성
    const config = {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        plugins: {
          bgColorPlugin: {
            alarm: null,
            warning: null
          },
          title: {
            display: true,
            text: [[${sensorName}]],
            font: {
              size: 22,
              weight: 'bold'
            },
            color: 'black'
          },
        },
        interaction: {
          intersect: false,
        },
        scales: {
          x: {
            display: true
          },
          y: {
            display: true,
            grace: 20
          }
        }
      },
      plugins: [bgColorPlugin]
    };

    // Thymeleaf에서 넘어온 값
    var deviceCodeValue = [[${deviceCode}]];
    var sensorKeyValue = [[${sensorKey}]];

    var ctx = document.getElementById('chart').getContext('2d');
    var myChart = new Chart(ctx, config);

    // 센서 꺼짐 처리
    var offCheck = setInterval(function() {
      var th = thresholdMap[deviceCodeValue + "_" + sensorKeyValue];
      if(th && th.status == 0) {
        document.getElementById("chart").style.display = "none";
        document.getElementById("offMessage").style.display = "block";
        eventSource.close();
        clearInterval(offCheck);
      }
    });

    var thresholdMap = {};  // 임계치 정보를 저장할 Map
    var firstLoaded = false;

    function connectSSE() {
      // SSE 연결
      var eventSource = new EventSource("/SpringGroupBB/sensor/sensorList/sse");

      // 센서 꺼짐 처리
      var offCheck = setInterval(function() {
        var th = thresholdMap[deviceCodeValue + "_" + sensorKeyValue];
        if(th && th.status == 0) {
          document.getElementById("chart").style.display = "none";
          document.getElementById("offMessage").style.display = "block";
          eventSource.close();
          clearInterval(offCheck);
        }
      });

      eventSource.onmessage = function(event) {

        var jsonData = JSON.parse(event.data);
        var sensorList = jsonData.sensor;
        var thresholdList = jsonData.threshold;

        // thresholdMap 생성
        for(var i = 0; i < thresholdList.length; i++) {
          var th = thresholdList[i];
          thresholdMap[th.deviceCode + "_" + th.sensorKey] = th;
        }

        // 현재 디바이스 센서 찾기
        var target = null;
        for(var i = 0; i < sensorList.length; i++) {
          if(sensorList[i].deviceCode === deviceCodeValue) {
            target = sensorList[i];
            break;
          }
        }
        if(target == null) return;

        var value = target[sensorKeyValue];
        if(value == null) return;

        var key = deviceCodeValue + "_" + sensorKeyValue;
        var threshold = thresholdMap[key];

        var alarmValue = threshold ? threshold.alarm : null;
        var warningValue = threshold ? threshold.warning : null;

        myChart.options.plugins.bgColorPlugin.alarm = alarmValue;
        myChart.options.plugins.bgColorPlugin.warning = warningValue;

        var now = new Date();
        var year  = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, "0");
        var day   = String(now.getDate()).padStart(2, "0");
        var hour  = String(now.getHours()).padStart(2, "0");
        var min   = String(now.getMinutes()).padStart(2, "0");

        var time = year + "-" + month + "-" + day + " " + hour + ":" + min;

        data.labels.push(time);
        data.datasets[0].data.push(value);
        data.datasets[1].data.push(alarmValue);
        data.datasets[2].data.push(warningValue);

        if(data.labels.length > 50) {
          data.labels.shift();
          data.datasets[0].data.shift();
          data.datasets[1].data.shift();
          data.datasets[2].data.shift();
        }

        if(myChart != null) myChart.update();
      };
    }

    // SSE 연결은 초기 20건 로드가 끝난 뒤 실행
    eventSource_firstLoad = true;

    // SSE 최초 메시지 진입
    var eventSource_first = new EventSource("/SpringGroupBB/sensor/sensorList/sse");
    eventSource_first.onmessage = function(event) {

      var jsonData = JSON.parse(event.data);
      var sensorList = jsonData.sensor;

      var target = null;
      for(var i = 0; i < sensorList.length; i++) {
        if(sensorList[i].deviceCode === deviceCodeValue) {
          target = sensorList[i];
          break;
        }
      }
      if(target == null) return;

      var nowTime = target.measureDatetime;

      if(firstLoaded == false) {
        firstLoaded = true;

        $.ajax({
          url: "/SpringGroupBB/sensor/sensorPopup/history",
          type: "get",
          data: {
            deviceCode: deviceCodeValue,
            sensorKey: sensorKeyValue,
            nowTime: nowTime
          },
          success: function(list) {

            for(var i = 0; i < list.length; i++) {
              var entity = list[i];

              var pastValue = entity[sensorKeyValue];
              if(pastValue == null) continue;

              var alarmValue = entity.threshold ? entity.threshold.alarm : null;
              var warningValue = entity.threshold ? entity.threshold.warning : null;

              var dateObj = entity.measureDatetime;
              var timeLabel = dateObj.substring(0, 10) + " " + dateObj.substring(11, 16);

              data.labels.push(timeLabel);
              data.datasets[0].data.push(pastValue);
              data.datasets[1].data.push(alarmValue);
              data.datasets[2].data.push(warningValue);
            }

            if(myChart != null) myChart.update();

            // 이제 진짜 SSE 연결 시작
            connectSSE();

            // 초기용 SSE 종료
            eventSource_first.close();
          }
        });
      }
    };
  }

  // EventLog ========================================================================
  var currentPage = 0;
  var pageSize = 20;

  function initEventLog() {
    var deviceCode = [[${deviceCode}]];
    var sensorKey = [[${sensorKey}]];
    var sensorName = [[${sensorName}]];

    $.ajax({
      url: "/SpringGroupBB/sensor/eventLog/list",
      type: "get",
      data: {
        deviceCode: deviceCode,
        sensorKey: sensorKey,
        page: currentPage,
        size: pageSize
      },
      success: function(res) {

        var list = res.data;
        var total = res.totalCount;

        var html = "";

        for(var i=0; i<list.length; i++) {
          var log = list[i];

          html += "<tr>"
                + "<td>" + ((currentPage * pageSize) + (i+1)) + "</td>"
                + "<td>" + sensorName + "</td>"
                + "<td>" + log.value + "</td>"
                + "<td>" + log.event + "</td>"
                + "<td>" + log.measureDatetime + "</td>"
                + "</tr>";
        }

        $("#logTable").html(html);

        makePagination(total);
      }
    });
  }

  // 페이지 버튼
  function goPage(page) {
    currentPage = page;
    initEventLog();
  }

  function makePagination(total) {
    var totalPages = Math.ceil(total / pageSize);
    var html = "";
    for(var i=0; i<totalPages; i++) {
      html += "<button onclick='goPage(" + i + ")'>" + (i+1) + "</button>";
    }
    $("#paginationArea1").html(html);
    $("#paginationArea2").html(html);
  }


  // 창 고정
  window.onload = function() {
    window.resizeTo(800, 700);
  };

  window.onresize = function() {
      window.resizeTo(800, 700);
  };
</script>

</body>
</html>
