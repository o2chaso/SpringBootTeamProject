<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/basicLayout}">

<th:block layout:fragment="script">
  <script th:inline="javascript">
    let currentDevice = "ENV_V2_1"; // 기본 선택

    // SSE 연결(Server-Sent Events / 실시간 서버-클라이언트 통신 기술)
    const eventSource = new EventSource("/sensor/sensorList/sse");

    eventSource.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const sensors = data.sensor;         // 리스트
      const threshold = data.threshold;

      const thresholdMap = {};
      threshold.forEach(t => {
        thresholdMap[t.deviceCode + "_" + t.sensorKey] = t;
      });

      console.log("받은 데이터", data);

      // 현재 선택된 deviceCode 찾기
      const target = sensors.find(s => s.deviceCode === currentDevice);
      if(!target) return;

      updateBox("value1", "실내온도", target.value1, thresholdMap[currentDevice + "_" + "value1"]);
      updateBox("value2", "상대습도", target.value2, thresholdMap[currentDevice + "_" + "value2"]);
      updateBox("value3", "이산화탄소", target.value3, thresholdMap[currentDevice + "_" + "value3"]);
      updateBox("value4", "유기화합물VOC", target.value4, thresholdMap[currentDevice + "_" + "value4"]);

      updateBox("value5", "초미세먼지 PM1.0", target.value5, thresholdMap[currentDevice + "_" + "value5"]);
      updateBox("value6", "초미세먼지 PM2.5", target.value6, thresholdMap[currentDevice + "_" + "value6"]);
      updateBox("value7", "초미세먼지 PM10", target.value7, thresholdMap[currentDevice + "_" + "value7"]);

      updateBox("value8", "온도_1", target.value8, thresholdMap[currentDevice + "_" + "value8"]);
      updateBox("value9", "온도_2", target.value9, thresholdMap[currentDevice + "_" + "value9"]);
      updateBox("value10", "온도_3", target.value10, thresholdMap[currentDevice + "_" + "value10"]);

      updateBox("value12", "소음", target.value12, thresholdMap[currentDevice + "_" + "value11"]);
      updateBox("value11", "온도(비접촉)", target.value11, thresholdMap[currentDevice + "_" + "value12"]);
      updateBox("value13", "노이즈", target.value13, thresholdMap[currentDevice + "_" + "value13"]);
    };

    // 인터락 값에 따른 대시보드 색상변경
    function updateBox(id, label, value, threshold) {
      const box = document.getElementById(id);

      let bgColor = "#28a745";

      if(threshold && typeof threshold.alarm === "number" && typeof threshold.warning === "number") {
        if(value >= threshold.alarm) bgColor = "#dc3545";
        else if(value >= threshold.warning) bgColor = "#ffc107";
      }

      box.style.backgroundColor = bgColor;
      box.style.color = "#fff";

      box.innerHTML =
        "<div style='font-size: 16px; margin-bottom: 10px;'>" + label + "</div>" +
        "<div style='font-size: 28px; font-weight: bold;'>" + value + "</div>"
    }

    // 장치 선택 변경 함수
    function changeDevice() {
      const selectBox = document.getElementById("deviceSelect");
      currentDevice = selectBox.value;
    }

    // 대시보드 팝업 띄우기
    function openSensorPopup(sensorKey) {
      const device = currentDevice;
      window.open("/sensor/sensorPopup?deviceCode=" + device + "&sensorKey=" + sensorKey, "_blank", "width=900,height=700");
    }
  </script>
</th:block>

<div layout:fragment="content">
  <div class="text-start">
    <a th:href="@{/sensor/sensorInterlock}" class="btn btn-primary" style="margin-left: 20px; ont-size: 18px; padding: 8px;">Interlock</a>
  </div>

  <!-- 상단 선택 박스 -->
  <div style="margin-bottom: 20px;">
    <label style="font-size: 18px; margin-right: 10px;">장치 선택 :</label>
    <select id="deviceSelect" onchange="changeDevice()" style="padding: 8px; font-size: 16px">
      <option value="ENV_V2_1">1층(ENV_V2_1)</option>
      <option value="ENV_V2_2">2층(ENV_V2_2)</option>
      <option value="ENV_V2_3">자재실(ENV_V2_3)</option>
      <option value="ENV_V2_4">개발실(ENV_V2_4)</option>
    </select>
  </div>

  <!-- 센서 대시보드 -->
  <div class="sensor-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 25px;">
    <div class="card" id="value1" onclick="openSensorPopup('value1')" style="cursor: pointer;">
    </div>
    <div class="card" id="value2" onclick="openSensorPopup('value2')" style="cursor: pointer;"></div>
    <div class="card" id="value3" onclick="openSensorPopup('value3')" style="cursor: pointer;"></div>
    <div class="card" id="value4" onclick="openSensorPopup('value4')" style="cursor: pointer;"></div>
    <div class="card" id="value5" onclick="openSensorPopup('value5')" style="cursor: pointer;"></div>
    <div class="card" id="value6" onclick="openSensorPopup('value6')" style="cursor: pointer;"></div>
    <div class="card" id="value7" onclick="openSensorPopup('value7')" style="cursor: pointer;"></div>
    <div class="card" id="value8" onclick="openSensorPopup('value8')" style="cursor: pointer;"></div>
    <div class="card" id="value9" onclick="openSensorPopup('value9')" style="cursor: pointer;"></div>
    <div class="card" id="value10" onclick="openSensorPopup('value10')" style="cursor: pointer;"></div>
    <div class="card" id="value11" onclick="openSensorPopup('value11')" style="cursor: pointer;"></div>
    <div class="card" id="value12" onclick="openSensorPopup('value12')" style="cursor: pointer;"></div>
    <div class="card" id="value13" onclick="openSensorPopup('value13')" style="cursor: pointer;"></div>
    <div class="card" id="value14" onclick="openSensorPopup('value14')"></div>
    <div class="card" id="value15" onclick="openSensorPopup('value15')"></div>
    <div class="card" id="value16" onclick="openSensorPopup('value16')"></div>

  </div>
</div>>

</html>